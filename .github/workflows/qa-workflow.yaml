name: QA Workflow - Enhanced Test Suite with PromptCheck

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
  workflow_dispatch:
    inputs:
      run_prompt_tests:
        description: "Run PromptCheck validation"
        required: false
        default: true
        type: boolean

jobs:
  # ===============================================
  # PROMPT VALIDATION - NEW JOB
  # ===============================================
  validate-prompts:
    name: Validate Copilot Prompts with PromptCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Preparar tests de prompts
        run: |
          mkdir -p tests
          echo "Preparando tests para validaciÃ³n de prompts..."
          # Crear estructura de tests si no existe
          if [ ! -f "promptcheck.config.yaml" ]; then
            cat > promptcheck.config.yaml << 'EOF'
          version: "1.0"
          settings:
            output_format: json
            fail_on_error: true
            verbose: true

          rules:
            - name: clarity
              enabled: true
              severity: error
            - name: consistency
              enabled: true
              severity: warning
            - name: specificity
              enabled: true
              severity: error
          EOF
          fi

      - name: PromptCheck Action
        uses: PromptCheck/promptcheck@v0.1.0-beta
        with:
          test_path: tests/
          config_dir: .
          output_dir: promptcheck-results
          github_token: ${{ github.token }}
        continue-on-error: true

      - name: Analizar resultados de PromptCheck
        if: always()
        run: |
          if [ -d "promptcheck-results" ]; then
            echo "ðŸ“Š Resultados de validaciÃ³n de prompts:"
            cat promptcheck-results/run.json | jq '.' || true
          fi

      - name: Subir reporte de prompts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prompt-validation-report
          path: |
            promptcheck-results/
            promptcheck.config.yaml
          retention-days: 30
